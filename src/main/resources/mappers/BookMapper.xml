<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.myapp.dao.BookMapper">


    <!-- Book + Category -->
    <resultMap id="BookMap" type="com.example.myapp.domain.Book">
        <id     property="id"         column="id"/>
        <result property="title"      column="title"/>
        <result property="author"     column="author"/>
        <result property="translator" column="translator"/>
        <result property="price"      column="price"/>
        <result property="imageUrl"   column="image_url"/>
        <result property="badge"      column="badge"/>
        <result property="publisher"  column="publisher"/>
        <result property="isbn"       column="isbn"/>
        <result property="status"     column="status"/>
        <result property="categoryId" column="category_id"/>
        <result property="createdAt"  column="created_at"/>
        <result property="updatedAt"  column="updated_at"/>

        <association property="category" javaType="com.example.myapp.domain.Category">
            <id     property="id"    column="c_id"/>
            <result property="code"  column="c_code"/>
            <result property="name"  column="c_name"/>
            <result property="parentId" column="c_parent_id"/>
        </association>
    </resultMap>

    <select id="searchBooks" resultMap="BookMap">
        SELECT
        b.*,
        c.id   AS c_id,
        c.code AS c_code,
        c.name AS c_name,
        c.parent_id AS c_parent_id
        FROM books b
        LEFT JOIN categories c ON c.id = b.category_id
        WHERE 1=1
        <if test="q != null and q != ''">
            AND (LOWER(b.title) LIKE LOWER(CONCAT('%', #{q}, '%'))
            OR LOWER(b.author) LIKE LOWER(CONCAT('%', #{q}, '%')))
        </if>
        <if test="categoryCode != null and categoryCode != ''">
            AND c.code = #{categoryCode}
        </if>
        <if test="status != null and status != ''">
            AND b.status = #{status}
        </if>
        ORDER BY
        <choose>
            <when test="sort == 'title,asc'">b.title ASC</when>
            <when test="sort == 'title,desc'">b.title DESC</when>
            <when test="sort == 'price,asc'">b.price ASC</when>
            <when test="sort == 'price,desc'">b.price DESC</when>
            <otherwise>b.id DESC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countBooks" resultType="long">
        SELECT COUNT(*)
        FROM books b
        LEFT JOIN categories c ON c.id = b.category_id
        WHERE 1=1
        <if test="q != null and q != ''">
            AND (LOWER(b.title) LIKE LOWER(CONCAT('%', #{q}, '%'))
            OR LOWER(b.author) LIKE LOWER(CONCAT('%', #{q}, '%')))
        </if>
        <if test="categoryCode != null and categoryCode != ''">
            AND c.code = #{categoryCode}
        </if>
        <if test="status != null and status != ''">
            AND b.status = #{status}
        </if>
    </select>

    <select id="findBookById" parameterType="long" resultMap="BookMap">
        SELECT
            b.*,
            c.id   AS c_id,
            c.code AS c_code,
            c.name AS c_name,
            c.parent_id AS c_parent_id
        FROM books b
                 LEFT JOIN categories c ON c.id = b.category_id
        WHERE b.id = #{id}
    </select>

    <!-- BookDetail - 중복 제거, 단순하게 처리 -->
    <resultMap id="BookDetailMap" type="com.example.myapp.domain.BookDetail">
        <result property="bookId"          column="book_id"/>
        <result property="description"     column="description"/>
        <result property="pages"           column="pages"/>
        <result property="publicationDate" column="publication_date"/>
        <result property="binding"         column="binding"/>
        <result property="language"        column="language"/>
        <result property="keywords"        column="keywords"/>
    </resultMap>

    <select id="findDetailByBookId" resultMap="BookDetailMap">
        SELECT
            book_id,
            description,
            pages,
            publication_date,
            binding,
            language,
            keywords::text as keywords
        FROM book_details
        WHERE book_id = #{bookId}
            LIMIT 1
    </select>

    <!-- TOC -->
    <resultMap id="BookTocItemMap" type="com.example.myapp.domain.BookTocItem">
        <result property="bookId"   column="book_id"/>
        <result property="seq"      column="seq"/>
        <result property="title"    column="title"/>
        <result property="pageFrom" column="page_from"/>
        <result property="pageTo"   column="page_to"/>
    </resultMap>

    <select id="findTocByBookId" resultMap="BookTocItemMap">
        SELECT book_id, seq, title, page_from, page_to
        FROM book_toc_items
        WHERE book_id = #{bookId}
        ORDER BY seq ASC
    </select>

    <!-- Author Notes -->
    <resultMap id="BookAuthorNotesMap" type="com.example.myapp.domain.BookAuthorNotes">
        <result property="bookId"        column="book_id"/>
        <result property="authorBio"     column="author_bio"/>
        <result property="translatorBio" column="translator_bio"/>
    </resultMap>

    <select id="findAuthorNotesByBookId" resultMap="BookAuthorNotesMap">
        SELECT book_id, author_bio, translator_bio
        FROM book_author_notes
        WHERE book_id = #{bookId}
            LIMIT 1
    </select>

    <!-- Reviews -->
    <resultMap id="BookReviewMap" type="com.example.myapp.domain.BookReview">
        <id     property="id"           column="id"/>
        <result property="bookId"       column="book_id"/>
        <result property="rating"       column="rating"/>
        <result property="title"        column="title"/>
        <result property="content"      column="content"/>
        <result property="userDisplay"  column="user_display"/>
        <result property="helpfulCount" column="helpful_count"/>
        <result property="createdAt"    column="created_at"/>
    </resultMap>

    <select id="findReviews" resultMap="BookReviewMap">
        SELECT id, book_id, rating, title, content, user_display, helpful_count, created_at
        FROM book_reviews
        WHERE book_id = #{bookId}
        ORDER BY
        <choose>
            <when test="orderBy == 'helpful_count'">
                helpful_count DESC, id DESC
            </when>
            <otherwise>
                created_at DESC, id DESC
            </otherwise>
        </choose>
        LIMIT #{limit}
        OFFSET #{offset}
    </select>

    <select id="countReviews" resultType="long">
        SELECT COUNT(*) FROM book_reviews WHERE book_id = #{bookId}
    </select>

</mapper>