<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.myapp.dao.BookMapper">

    <!-- 공통 resultMap: Book + Category 매핑 -->
    <resultMap id="BookMap" type="com.example.myapp.domain.Book">
        <id     property="id"        column="id"/>
        <result property="title"     column="title"/>
        <result property="author"    column="author"/>
        <result property="translator" column="translator"/>
        <result property="price"     column="price"/>
        <result property="imageUrl"  column="image_url"/>
        <result property="badge"     column="badge"/>
        <result property="publisher" column="publisher"/>
        <result property="isbn"      column="isbn"/>
        <result property="status"    column="status"/>

        <association property="category" javaType="com.example.myapp.domain.Category">
            <id     property="id"   column="category_id"/>
            <result property="code" column="category_code"/>
            <result property="name" column="category_name"/>
        </association>
    </resultMap>

    <!-- 목록 조회 -->
    <select id="selectPage" resultMap="BookMap">
        SELECT
        b.id, b.title, b.author, b.translator, b.price, b.image_url,
        b.badge, b.publisher, b.isbn, b.status, b.category_id,
        c.code AS category_code, c.name AS category_name
        FROM books b
        LEFT JOIN categories c ON c.id = b.category_id
        <where>
            <if test="q != null and q != ''">
                (LOWER(b.title) LIKE LOWER(CONCAT('%', #{q}, '%'))
                OR LOWER(b.author) LIKE LOWER(CONCAT('%', #{q}, '%')))
            </if>
            <if test="category != null and category != ''">
                AND c.code = #{category}
            </if>
            <if test="status != null and status != ''">
                AND b.status = #{status}
            </if>
        </where>
        ORDER BY ${orderBy}
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 카운트 -->
    <select id="selectCount" resultType="long">
        SELECT COUNT(b.id)
        FROM books b
        LEFT JOIN categories c ON c.id = b.category_id
        <where>
            <if test="q != null and q != ''">
                (LOWER(b.title) LIKE LOWER(CONCAT('%', #{q}, '%'))
                OR LOWER(b.author) LIKE LOWER(CONCAT('%', #{q}, '%')))
            </if>
            <if test="category != null and category != ''">
                AND c.code = #{category}
            </if>
            <if test="status != null and status != ''">
                AND b.status = #{status}
            </if>
        </where>
    </select>

    <!-- 단건 -->
    <select id="selectOne" resultMap="BookMap">
        SELECT
            b.id, b.title, b.author, b.translator, b.price, b.image_url,
            b.badge, b.publisher, b.isbn, b.status, b.category_id,
            c.code AS category_code, c.name AS category_name
        FROM books b
                 LEFT JOIN categories c ON c.id = b.category_id
        WHERE b.id = #{id}
    </select>

</mapper>
